<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>iPad Camera</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden;
      touch-action: manipulation;
    }
    #wrap {
      position: relative; width: 100%; height: 100%;
    }
    video{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:90vw;
  height:calc(90vw * 4 / 3);
  max-height:80vh;
  object-fit:contain; /* åã¾ã‚Šå„ªå…ˆ */
}
    /* ä¸‹éƒ¨UI */
    #controls {
      position: absolute; left: 0; right: 0; bottom: 20px;
      display: flex; align-items: center; justify-content: center; gap: 18px;
      pointer-events: none;
    }
    /* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
    #shutter {
      width: 76px; height: 76px; border-radius: 50%;
      background: #fff; box-shadow: 0 0 0 6px rgba(255,255,255,.35) inset;
      pointer-events: auto; border: none;
    }
    /* ã‚ºãƒ¼ãƒ  */
    #zoom {
      position: absolute; right: 16px; bottom: 110px;
      display: flex; flex-direction: column; gap: 10px;
      pointer-events: auto;
    }
    .zbtn {
      background: rgba(0,0,0,.6); color: #fff; border: 1px solid #fff;
      border-radius: 999px; padding: 8px 12px; font-size: 14px;
    }
    #guide{
    position:absolute;
    inset:0;
    display:none;
    pointer-events:none;
  }
  #guide::before{
    content:"";
    position:absolute;inset:0;
    background:
      linear-gradient(to right, rgba(255,255,255,.6) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,.6) 1px, transparent 1px);
    background-size:33.333% 33.333%;
  }
</style>
</head>
<body>
  <div id="wrap">

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ -->
  <div id="preview" style="display:none;">
    <img id="previewImg" />
    <div id="previewUI" style="position:absolute;top:16px;left:16px;right:16px;display:flex;justify-content:space-between;pointer-events:auto;">
      <button id="backBtn" class="zbtn">ğŸ“· ã‚«ãƒ¡ãƒ©ã«æˆ»ã‚‹</button>
      <button id="shareBtn" class="zbtn">å…±æœ‰</button>
    </div>
  </div>

    <video id="video" autoplay playsinline></video>

    <button id="startCamera" class="zbtn" style="position:absolute;top:12px;right:12px;height:36px;padding:0 10px;font-size:12px;pointer-events:auto;">èµ·å‹•</button>

    

    

    <div id="zoom">
      <button class="zbtn" data-z="1">1Ã—</button>
      <button class="zbtn" data-z="2">2Ã—</button>
      <button class="zbtn" data-z="4">4Ã—</button>
      <button class="zbtn" data-z="8">8Ã—</button>
    </div>

    <div id="controls">
      <button id="shutter" aria-label="shutter"></button>
    </div>

    <!-- ã‚¬ã‚¤ãƒ‰æ  -->
    <div id="guide"></div>

    <!-- ã‚¬ã‚¤ãƒ‰ON/OFF -->
    <button id="guideToggle" class="zbtn" style="position:absolute;left:16px;bottom:20px;pointer-events:auto;">ã‚¬ã‚¤ãƒ‰ON</button>

  </div>

  <script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const zoomBtns = document.querySelectorAll('[data-z]');
const guide = document.getElementById('guide');
const guideToggle = document.getElementById('guideToggle');
const startBtn = document.getElementById('startCamera');

let stream = null;
let track = null;
let imageCapture = null;

// ===== ã‚«ãƒ¡ãƒ©èµ·å‹• =====
async function startCamera() {
  const btn = document.getElementById('startCamera');
  try {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode:{ ideal:'environment' } },
      audio:false
    });

    video.srcObject = stream;
    video.muted = true;
    await video.play();

    track = stream.getVideoTracks()[0];
    imageCapture = 'ImageCapture' in window ? new ImageCapture(track) : null;

    btn.style.display = 'none';
  } catch (e) {
    console.error(e);
    btn.style.display = 'block';
    alert('ã‚«ãƒ¡ãƒ©èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}() {
  try {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }

    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'environment' }
      },
      audio: false
    });

    video.srcObject = stream;
    video.muted = true; // iOSå¿…é ˆ
    video.setAttribute('playsinline', '');

    await video.play();

    track = stream.getVideoTracks()[0];
    imageCapture = 'ImageCapture' in window ? new ImageCapture(track) : null;

    startBtn.style.display = 'none';
  } catch (e) {
    console.error(e);
    alert('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆHTTPSã‹Safariã§é–‹ã„ã¦ã„ã¾ã™ã‹ï¼Ÿï¼‰');
    startBtn.style.display = 'block';
  }
}

    stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'environment' }
      },
      audio: false
    });

    video.srcObject = stream;
    video.muted = true; // iOSå¯¾ç­–
    await video.play();

    track = stream.getVideoTracks()[0];
    if ('ImageCapture' in window) {
      imageCapture = new ImageCapture(track);
    }

    startBtn.style.display = 'none';
  } catch (e) {
    alert('ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    startBtn.style.display = 'block';
  }
}

startBtn.addEventListener('click', startCamera);

// ===== æ’®å½± =====
shutter.onclick = async () => {
  if (!track) return;

  let blob;
  if (imageCapture?.takePhoto) {
    blob = await imageCapture.takePhoto();
  } else {
    const c = document.createElement('canvas');
    c.width = video.videoWidth;
    c.height = video.videoHeight;
    c.getContext('2d').drawImage(video, 0, 0);
    blob = await new Promise(r => c.toBlob(r, 'image/jpeg', 0.95));
  }

  const url = URL.createObjectURL(blob);
  previewImg.src = url;
  preview.style.display = 'block';
  video.style.display = 'none';
  document.getElementById('controls').style.display = 'none';
  document.getElementById('zoom').style.display = 'none';

  shareBtn.onclick = async () => {
    if (navigator.share) {
      const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
      try { await navigator.share({ files:[file] }); } catch {}
    }
  };
};(url);
};

// ===== ã‚ºãƒ¼ãƒ  =====
zoomBtns.forEach(btn => {
  btn.onclick = async () => {
    if (!track) return;
    const z = Number(btn.dataset.z);

    if (track.getCapabilities) {
      const caps = track.getCapabilities();
      if (caps.zoom) {
        await track.applyConstraints({ advanced: [{ zoom: Math.min(z, caps.zoom.max) }] });
        return;
      }
    }
    video.style.transform = `scale(${z})`;
  };
});

// ===== ã‚¬ã‚¤ãƒ‰ ON / OFF =====
guideToggle.onclick = () => {
  const show = guide.style.display !== 'block';
  guide.style.display = show ? 'block' : 'none';
  guideToggle.textContent = show ? 'ã‚¬ã‚¤ãƒ‰OFF' : 'ã‚¬ã‚¤ãƒ‰ON';
};
</script>
</body>
</html>
