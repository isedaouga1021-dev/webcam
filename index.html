<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>iPad Camera</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

<style>
html,body{
  margin:0;height:100%;background:#000;overflow:hidden;
}
#wrap{position:relative;width:100%;height:100%;}
video,img{
  position:absolute;inset:0;
  width:100%;height:100%;
  object-fit:cover;
}

/* å…±é€šãƒœã‚¿ãƒ³ */
.zbtn{
  background:rgba(0,0,0,.6);
  color:#fff;border:1px solid #fff;
  border-radius:999px;
  padding:8px 12px;
}

/* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ */
#controls{
  position:absolute;left:0;right:0;bottom:20px;
  display:flex;justify-content:center;
}
#shutter{
  width:76px;height:76px;border-radius:50%;
  background:#fff;border:none;
}

/* ã‚ºãƒ¼ãƒ  */
#zoom{
  position:absolute;right:16px;bottom:110px;
  display:flex;flex-direction:column;gap:10px;
}

/* å†èµ·å‹• */
#reloadBtn{
  position:absolute;top:16px;right:16px;z-index:10;
}

/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
#preview{display:none;}
#previewUI{
  position:absolute;top:16px;left:0;right:0;
  display:flex;justify-content:space-between;
  padding:0 16px;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
#loading{
  display:none;
  position:absolute;inset:0;
  background:#000;
  color:#fff;
  z-index:99;
  align-items:center;
  justify-content:center;
  font-size:18px;
}
</style>
</head>

<body>
<div id="wrap">

  <video id="video" autoplay playsinline></video>

  <button id="reloadBtn" class="zbtn">âŸ³</button>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div id="preview">
    <img id="previewImg">
    <div id="previewUI">
      <button id="backBtn" class="zbtn">ğŸ“· æˆ»ã‚‹</button>
      <button id="saveBtn" class="zbtn">ğŸ’¾ ä¿å­˜</button>
    </div>
  </div>

  <!-- ã‚ºãƒ¼ãƒ  -->
  <div id="zoom">
    <button class="zbtn" data-z="1">1Ã—</button>
    <button class="zbtn" data-z="2">2Ã—</button>
    <button class="zbtn" data-z="4">4Ã—</button>
    <button class="zbtn" data-z="8">8Ã—</button>
  </div>

  <!-- ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ -->
  <div id="controls">
    <button id="shutter"></button>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
  <div id="loading">å†èµ·å‹•ä¸­â€¦</div>

</div>

<script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const zoomBtns = document.querySelectorAll('[data-z]');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const backBtn = document.getElementById('backBtn');
const saveBtn = document.getElementById('saveBtn');
const reloadBtn = document.getElementById('reloadBtn');
const loading = document.getElementById('loading');

let stream, track, imageCapture;

// ã‚«ãƒ¡ãƒ©èµ·å‹•
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:'environment',
      width:{ideal:10000},
      height:{ideal:10000}
    }
  });
  video.srcObject = stream;
  track = stream.getVideoTracks()[0];
  if('ImageCapture' in window){
    imageCapture = new ImageCapture(track);
  }
}
startCamera();

// æ’®å½±
shutter.onclick = async ()=>{
  let blob;
  if(imageCapture?.takePhoto){
    blob = await imageCapture.takePhoto();
  }else{
    const c = document.createElement('canvas');
    c.width = video.videoWidth;
    c.height = video.videoHeight;
    c.getContext('2d').drawImage(video,0,0);
    blob = await new Promise(r=>c.toBlob(r,'image/jpeg',0.95));
  }

  previewImg.src = URL.createObjectURL(blob);
  video.style.display = 'none';
  preview.style.display = 'block';
};

// æˆ»ã‚‹
backBtn.onclick = ()=>{
  preview.style.display = 'none';
  video.style.display = 'block';
  URL.revokeObjectURL(previewImg.src);
};

// ä¿å­˜
saveBtn.onclick = ()=>{
  const a = document.createElement('a');
  a.href = previewImg.src;
  a.download = `photo_${Date.now()}.jpg`;
  a.click();
};

// ã‚ºãƒ¼ãƒ 
zoomBtns.forEach(b=>{
  b.onclick = async ()=>{
    const z = Number(b.dataset.z);
    if(track?.getCapabilities){
      const caps = track.getCapabilities();
      if(caps.zoom){
        await track.applyConstraints({advanced:[{zoom:Math.min(z,caps.zoom.max)}]});
        return;
      }
    }
    video.style.transform = `scale(${z})`;
  };
});

// å†èµ·å‹•ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä»˜ãï¼‰
reloadBtn.onclick = ()=>{
  loading.style.display = 'flex';
  setTimeout(()=>location.reload(),300);
};

// Service Workerç™»éŒ²
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
