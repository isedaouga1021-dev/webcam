<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>iPad Camera</title>

<style>
html,body{
  margin:0;
  height:100%;
  background:#000;
  overflow:hidden;
}
#wrap{
  position:relative;
  width:100%;
  height:100%;
}

/* ===== „Ç´„É°„É©Ë°®Á§∫ÔºàÊ®™„ÅÑ„Å£„Å±„ÅÑÔºã4:3Ôºâ ===== */
#cameraFrame{
  position:absolute;
  inset:0;
  display:flex;
  justify-content:center;
  background:#000;
}
#cameraFrame video{
  width:100%;
  height:auto;
  aspect-ratio:4 / 3;
  object-fit:cover;
  align-self:center;
}

/* ÂÖ±ÈÄö„Éú„Çø„É≥ */
.zbtn{
  background:rgba(0,0,0,.6);
  color:#fff;
  border:1px solid #fff;
  border-radius:999px;
  padding:10px 14px;
  font-size:16px;
}

/* „Ç∑„É£„ÉÉ„Çø„Éº */
#controls{
  position:absolute;
  left:0; right:0;
  bottom:20px;
  display:flex;
  justify-content:center;
}
#shutter{
  width:76px;
  height:76px;
  border-radius:50%;
  background:#fff;
  border:none;
}

/* „Ç∫„Éº„É† */
#zoom{
  position:absolute;
  right:16px;
  bottom:110px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* ÂÜçËµ∑Âãï */
#reloadBtn{
  position:absolute;
  top:16px;
  right:16px;
  z-index:10;
}

/* ===== „Éó„É¨„Éì„É•„Éº ===== */
#preview{
  display:none;
  position:absolute;
  inset:0;
  background:#000;
}
#previewImg{
  position:absolute;
  top:40px;
  width:100%;
  height:calc(100% - 160px);
  object-fit:contain;
}
#previewTop{
  position:absolute;
  top:16px;
  left:16px;
}
#shareBar{
  position:absolute;
  left:0; right:0;
  bottom:24px;
  display:flex;
  justify-content:center;
}
#shareBtn{
  width:70%;
  padding:16px 0;
  font-size:18px;
}
</style>
</head>

<body>
<div id="wrap">

  <!-- „Ç´„É°„É© -->
  <div id="cameraFrame">
    <video id="video" autoplay playsinline></video>
  </div>

  <!-- ÂÜçËµ∑Âãï -->
  <button id="reloadBtn" class="zbtn">‚ü≥</button>

  <!-- „Éó„É¨„Éì„É•„Éº -->
  <div id="preview">
    <img id="previewImg">
    <div id="previewTop">
      <button id="backBtn" class="zbtn">üì∑ Êàª„Çã</button>
    </div>
    <div id="shareBar">
      <button id="shareBtn" class="zbtn">ÂÖ±Êúâ</button>
    </div>
  </div>

  <!-- „Ç∫„Éº„É† -->
  <div id="zoom">
    <button class="zbtn" data-z="1">1√ó</button>
    <button class="zbtn" data-z="2">2√ó</button>
    <button class="zbtn" data-z="4">4√ó</button>
    <button class="zbtn" data-z="8">8√ó</button>
  </div>

  <!-- „Ç∑„É£„ÉÉ„Çø„Éº -->
  <div id="controls">
    <button id="shutter"></button>
  </div>

</div>

<script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const zoom = document.getElementById('zoom');
const controls = document.getElementById('controls');
const zoomBtns = document.querySelectorAll('[data-z]');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const backBtn = document.getElementById('backBtn');
const shareBtn = document.getElementById('shareBtn');
const reloadBtn = document.getElementById('reloadBtn');

let stream, track, imageCapture;

// „Ç´„É°„É©Ëµ∑Âãï
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:'environment',
      width:{ideal:4032},
      height:{ideal:3024}
    }
  });
  video.srcObject = stream;
  track = stream.getVideoTracks()[0];
  if('ImageCapture' in window){
    imageCapture = new ImageCapture(track);
  }
}
startCamera();

// ÊíÆÂΩ±
shutter.onclick = async ()=>{
  let blob;
  if(imageCapture?.takePhoto){
    blob = await imageCapture.takePhoto();
  }else{
    const c = document.createElement('canvas');
    c.width = video.videoWidth;
    c.height = video.videoHeight;
    c.getContext('2d').drawImage(video,0,0);
    blob = await new Promise(r=>c.toBlob(r,'image/jpeg',0.95));
  }

  previewImg.src = URL.createObjectURL(blob);

  preview.style.display = 'block';
  controls.style.display = 'none';
  zoom.style.display = 'none';
};

// Êàª„Çã
backBtn.onclick = ()=>{
  preview.style.display = 'none';
  controls.style.display = 'flex';
  zoom.style.display = 'flex';
  URL.revokeObjectURL(previewImg.src);
};

// ÂÖ±Êúâ
shareBtn.onclick = async ()=>{
  if(!navigator.share){
    const a = document.createElement('a');
    a.href = previewImg.src;
    a.download = `photo_${Date.now()}.jpg`;
    a.click();
    return;
  }
  const res = await fetch(previewImg.src);
  const blob = await res.blob();
  const file = new File([blob], `photo_${Date.now()}.jpg`, {type:'image/jpeg'});
  try{
    await navigator.share({files:[file], title:'Photo'});
  }catch{}
};

// „Ç∫„Éº„É†
zoomBtns.forEach(b=>{
  b.onclick = async ()=>{
    const z = Number(b.dataset.z);
    if(track?.getCapabilities){
      const caps = track.getCapabilities();
      if(caps.zoom){
        await track.applyConstraints({
          advanced:[{zoom:Math.min(z,caps.zoom.max)}]
        });
        return;
      }
    }
    video.style.transform = `scale(${z})`;
  };
});

// ÂÜçËµ∑Âãï
reloadBtn.onclick = ()=> location.reload();
</script>
</body>
</html>
