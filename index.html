<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Simple Camera</title>
<style>
html,body{margin:0;height:100%;background:#000;overflow:hidden}
#wrap{position:relative;width:100%;height:100%}
#cameraBox{position:absolute;top:0;left:0;right:0;bottom:0;margin:auto;aspect-ratio:3/4;max-height:95%;max-width:100%}
video,canvas,img{width:100%;height:100%;object-fit:contain}
#controls{position:absolute;bottom:20px;left:0;right:0;display:flex;justify-content:center;gap:20px}
button{background:rgba(0,0,0,.6);color:#fff;border:1px solid #fff;border-radius:999px;padding:10px 16px;font-size:14px}
#shutter{width:72px;height:72px;border-radius:50%;background:#fff;border:none}
#zoom{position:absolute;right:12px;bottom:120px;display:flex;flex-direction:column;gap:10px}
#grid{position:absolute;inset:0;pointer-events:none;display:none}
.gridLine{position:absolute;background:rgba(255,255,255,.4)}
#preview{position:absolute;inset:0;background:#000;display:none;flex-direction:column;justify-content:space-between}
#preview img{flex:1;object-fit:contain}
#previewBtns{display:flex;justify-content:space-around;padding:16px}
</style>
</head>
<body>
<div id="wrap">

  <div id="cameraBox">
    <video id="video" playsinline></video>
    <div id="grid">
      <div class="gridLine" style="left:33%;top:0;width:1px;height:100%"></div>
      <div class="gridLine" style="left:66%;top:0;width:1px;height:100%"></div>
      <div class="gridLine" style="top:33%;left:0;height:1px;width:100%"></div>
      <div class="gridLine" style="top:66%;left:0;height:1px;width:100%"></div>
    </div>
  </div>

  <div id="zoom">
    <button data-z="1">1×</button>
    <button data-z="2">2×</button>
    <button data-z="4">4×</button>
  </div>

  <div id="controls">
    <button id="gridBtn">GRID</button>
    <button id="shutter"></button>
  </div>

  <div id="preview">
    <img id="previewImg">
    <div id="previewBtns">
      <button id="backBtn">戻る</button>
      <button id="shareBtn">共有</button>
    </div>
  </div>
</div>

<script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const backBtn = document.getElementById('backBtn');
const shareBtn = document.getElementById('shareBtn');
const grid = document.getElementById('grid');
const gridBtn = document.getElementById('gridBtn');
const zoomBtns = document.querySelectorAll('[data-z]');

let stream, track, lastBlob;

async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:'environment',
      width:{ideal:8000},
      height:{ideal:8000}
    },
    audio:false
  });
  video.srcObject = stream;
  await video.play();
  track = stream.getVideoTracks()[0];
}
startCamera();

shutter.onclick = ()=>{
  const c = document.createElement('canvas');
  c.width = video.videoWidth;
  c.height = video.videoHeight;
  c.getContext('2d').drawImage(video,0,0);
  c.toBlob(b=>{
    lastBlob = b;
    previewImg.src = URL.createObjectURL(b);
    preview.style.display='flex';
  },'image/jpeg',0.95);
};

backBtn.onclick = ()=>{
  preview.style.display='none';
  URL.revokeObjectURL(previewImg.src);
};

shareBtn.onclick = async ()=>{
  if(navigator.share){
    const file = new File([lastBlob],'photo.jpg',{type:'image/jpeg'});
    await navigator.share({files:[file]});
  }
};

gridBtn.onclick = ()=>{
  grid.style.display = grid.style.display==='none'?'block':'none';
};

zoomBtns.forEach(b=>{
  b.onclick = async ()=>{
    const z = Number(b.dataset.z);
    if(track?.getCapabilities){
      const caps = track.getCapabilities();
      if(caps.zoom){
        await track.applyConstraints({advanced:[{zoom:Math.min(z,caps.zoom.max)}]});
        return;
      }
    }
    video.style.transform = `scale(${z})`;
  };
});
</script>
</body>
</html>
