<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>iPad Camera</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; background: #000; overflow: hidden;
      touch-action: manipulation;
    }
    #wrap {
      position: relative; width: 100%; height: 100%;
    }
    video {
      position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
    }
    /* ‰∏ãÈÉ®UI */
    #controls {
      position: absolute; left: 0; right: 0; bottom: 20px;
      display: flex; align-items: center; justify-content: center; gap: 18px;
      pointer-events: none;
    }
    /* „Ç∑„É£„ÉÉ„Çø„Éº„Éú„Çø„É≥ */
    #shutter {
      width: 76px; height: 76px; border-radius: 50%;
      background: #fff; box-shadow: 0 0 0 6px rgba(255,255,255,.35) inset;
      pointer-events: auto; border: none;
    }
    /* „Ç∫„Éº„É† */
    #zoom {
      position: absolute; right: 16px; bottom: 110px;
      display: flex; flex-direction: column; gap: 10px;
      pointer-events: auto;
    }
    .zbtn {
      background: rgba(0,0,0,.6); color: #fff; border: 1px solid #fff;
      border-radius: 999px; padding: 8px 12px; font-size: 14px;
    }
    #guide{
    position:absolute;
    inset:0;
    display:none;
    pointer-events:none;
  }
  #guide::before{
    content:"";
    position:absolute;inset:0;
    background:
      linear-gradient(to right, rgba(255,255,255,.6) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,.6) 1px, transparent 1px);
    background-size:33.333% 33.333%;
  }
</style>
</head>
<body>
  <div id="wrap">

  <!-- „Éó„É¨„Éì„É•„ÉºÁîªÈù¢ -->
  <div id="preview" style="display:none;">
    <img id="previewImg" />
    <div id="previewUI" style="position:absolute;top:16px;left:16px;right:16px;display:flex;justify-content:space-between;pointer-events:auto;">
      <button id="backBtn" class="zbtn">üì∑ „Ç´„É°„É©„Å´Êàª„Çã</button>
      <button id="shareBtn" class="zbtn">ÂÖ±Êúâ</button>
    </div>
  </div>

    <video id="video" playsinline></video>

    <button id="startCamera" class="zbtn" style="position:absolute;top:12px;right:12px;height:36px;padding:0 10px;font-size:12px;pointer-events:auto;">Ëµ∑Âãï</button>

    

    

    <div id="zoom">
      <button class="zbtn" data-z="1">1√ó</button>
      <button class="zbtn" data-z="2">2√ó</button>
      <button class="zbtn" data-z="4">4√ó</button>
      <button class="zbtn" data-z="8">8√ó</button>
    </div>

    <div id="controls">
      <button id="shutter" aria-label="shutter"></button>
    </div>

    <!-- „Ç¨„Ç§„ÉâÊû† -->
    <div id="guide"></div>

    <!-- „Ç¨„Ç§„ÉâON/OFF -->
    <button id="guideToggle" class="zbtn" style="position:absolute;left:16px;bottom:20px;pointer-events:auto;">„Ç¨„Ç§„ÉâON</button>

  </div>

  <script>
    const video = document.getElementById('video');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const backBtn = document.getElementById('backBtn');
const shareBtn = document.getElementById('shareBtn');
    const shutter = document.getElementById('shutter');
    const zoomBtns = document.querySelectorAll('[data-z]');
const guide = document.getElementById('guide');
const guideToggle = document.getElementById('guideToggle');('.zbtn');
    
    let stream, track, imageCapture;

    async function startCamera() {
      const btn = document.getElementById('startCamera');
      try {
        // Âøµ„ÅÆ„Åü„ÇÅÊØéÂõûÂÅúÊ≠¢
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
        }

        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 10000 },
            height: { ideal: 10000 }
          },
          audio: false
        });

        video.srcObject = stream;
        video.muted = true; // iOSÂØæÁ≠ñ
        await video.play(); // ‚òÖ „Åì„Çå„ÅåÁÑ°„ÅÑ„Å®Áúü„Å£Èªí„Å´„Å™„Çã„Åì„Å®„Åå„ÅÇ„Çã

        track = stream.getVideoTracks()[0];
        if ('ImageCapture' in window) imageCapture = new ImageCapture(track);

        btn.style.display = 'none';
      } catch (e) {
        alert('„Ç´„É°„É©Ëµ∑ÂãïÂ§±Êïó: ' + e.name);
        btn.style.display = 'block';
      }
    },
          height: { ideal: 10000 }
        },
        audio: false
      });
      video.srcObject = stream;
      track = stream.getVideoTracks()[0];
      if ('ImageCapture' in window) imageCapture = new ImageCapture(track);
    }

    // „Ç∑„É£„ÉÉ„Çø„ÉºÔºöÁ¢∫Ë™çÁîªÈù¢„Å™„Åó„ÅßÂç≥„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    shutter.addEventListener('click', async () => {
  try {
    let blob;
    if (imageCapture && imageCapture.takePhoto) {
      blob = await imageCapture.takePhoto();
    } else {
      const c = document.createElement('canvas');
      c.width = video.videoWidth; c.height = video.videoHeight;
      c.getContext('2d').drawImage(video, 0, 0);
      blob = await new Promise(res => c.toBlob(res, 'image/jpeg', 0.95));
    }

    previewImg.src = URL.createObjectURL(blob);
    preview.style.display = 'block';
    video.style.display = 'none';
    document.getElementById('controls').style.display = 'none';
    document.getElementById('zoom').style.display = 'none';

    shareBtn.onclick = async () => {
      if (navigator.share) {
        const file = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
        try {
          await navigator.share({ files: [file], title: 'Photo' });
        } catch {}
      }
    };

  } catch {
    alert('ÊíÆÂΩ±„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
  }
});
      } catch (e) {
        alert('ÊíÆÂΩ±„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
      }
    });
            } catch {
              alert('„Åì„ÅÆÁ´ØÊú´Ôºè„Éñ„É©„Ç¶„Ç∂„Åß„ÅØRAWÊíÆÂΩ±„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇJPEG„Åß‰øùÂ≠ò„Åó„Åæ„Åô„ÄÇ');
              blob = await imageCapture.takePhoto();
            }
          } else {
            blob = await imageCapture.takePhoto();
          }
        } else {
          // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàRAW‰∏çÂèØÔºâ
          const c = document.createElement('canvas');
          c.width = video.videoWidth; c.height = video.videoHeight;
          const ctx = c.getContext('2d');
          ctx.drawImage(video, 0, 0);
          blob = await new Promise(res => c.toBlob(res, 'image/jpeg', 0.95));
        }
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const ext = blob.type.includes('raw') ? 'dng' : 'jpg';
        a.href = url;
        a.download = `photo_${Date.now()}.${ext}`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('ÊíÆÂΩ±„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü');
      }
    });

    // „Ç∫„Éº„É†ÔºàÂØæÂøúÁ´ØÊú´„Åß„ÅØÂÖâÂ≠¶/„Éá„Ç∏„Çø„É´„Ç∫„Éº„É†„ÄÅÈùûÂØæÂøú„ÅØCSSÊã°Â§ßÔºâ
    zoomBtns.forEach(btn => btn.addEventListener('click', async () => {
      const z = Number(btn.dataset.z);
      if (track && track.getCapabilities) {
        const caps = track.getCapabilities();
        if (caps.zoom) {
          const zoom = Math.min(Math.max(z, caps.zoom.min), caps.zoom.max);
          await track.applyConstraints({ advanced: [{ zoom }] });
          return;
        }
      }
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
      video.style.transform = `scale(${z})`;
    }));

    // „Ç´„É°„É©Ëµ∑Âãï„ÅØ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂøÖÈ†àÔºàiOSÂØæÁ≠ñÔºâ
    backBtn.onclick = () => {
  preview.style.display = 'none';
  video.style.display = 'block';
  document.getElementById('controls').style.display = 'flex';
  document.getElementById('zoom').style.display = 'flex';
  URL.revokeObjectURL(previewImg.src);
};

// „Ç´„É°„É©Ëµ∑Âãï„ÅØ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂøÖÈ†àÔºàiOSÂØæÁ≠ñÔºâ
guideToggle.onclick = () => {
  const on = guide.style.display !== 'block';
  guide.style.display = on ? 'block' : 'none';
  guideToggle.textContent = on ? '„Ç¨„Ç§„ÉâOFF' : '„Ç¨„Ç§„ÉâON';
};

// „Ç´„É°„É©Ëµ∑Âãï„ÅØ„É¶„Éº„Ç∂„ÉºÊìç‰ΩúÂøÖÈ†àÔºàiOSÂØæÁ≠ñÔºâ
document.getElementById('startCamera').addEventListener('click', () => {
      startCamera();
    });
  </script>
</body>
</html>
