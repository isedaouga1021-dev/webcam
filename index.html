<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>iPad Camera</title>

<style>
html,body{
  margin:0;height:100%;background:#000;overflow:hidden;
}
#wrap{position:relative;width:100%;height:100%;}

/* ===== ã‚«ãƒ¡ãƒ©è¡¨ç¤º ===== */
#cameraFrame{
  position:absolute;inset:0;
  display:flex;justify-content:center;
}
video{
  width:100%;
  height:auto;
  aspect-ratio:4/3;
  object-fit:cover;
  align-self:center;
}

/* å…±é€šãƒœã‚¿ãƒ³ */
.zbtn{
  background:rgba(0,0,0,.6);
  color:#fff;
  border:1px solid #fff;
  border-radius:999px;
  padding:8px 14px;
  font-size:14px;
}

/* ä¸Šéƒ¨UI */
#topBar{
  position:absolute;
  top:16px;left:16px;right:16px;
  display:flex;
  justify-content:space-between;
  z-index:10;
}
#orientationBtns{display:flex;gap:8px;}

/* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ */
#controls{
  position:absolute;
  left:0;right:0;bottom:20px;
  display:flex;justify-content:center;
}
#shutter{
  width:76px;height:76px;
  border-radius:50%;
  background:#fff;border:none;
}

/* ã‚ºãƒ¼ãƒ  */
#zoom{
  position:absolute;
  right:16px;bottom:110px;
  display:flex;flex-direction:column;gap:10px;
}

/* ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ===== */
#preview{
  display:none;
  position:absolute;inset:0;background:#000;
}
#previewImg{
  position:absolute;
  top:40px;
  width:100%;
  height:calc(100% - 160px);
  object-fit:contain;
}
#previewTop{
  position:absolute;top:16px;left:16px;
}
#shareBar{
  position:absolute;
  left:0;right:0;bottom:24px;
  display:flex;justify-content:center;
}
#shareBtn{
  width:70%;
  padding:16px 0;
  font-size:18px;
}
</style>
</head>

<body>
<div id="wrap">

  <!-- ä¸Šéƒ¨ãƒãƒ¼ -->
  <div id="topBar">
    <div id="orientationBtns">
      <button id="landBtn" class="zbtn">æ¨ª</button>
      <button id="portBtn" class="zbtn">ç¸¦</button>
    </div>
    <button id="reloadBtn" class="zbtn">âŸ³</button>
  </div>

  <!-- ã‚«ãƒ¡ãƒ© -->
  <div id="cameraFrame">
    <video id="video" autoplay playsinline></video>
  </div>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div id="preview">
    <img id="previewImg">
    <div id="previewTop">
      <button id="backBtn" class="zbtn">ðŸ“· æˆ»ã‚‹</button>
    </div>
    <div id="shareBar">
      <button id="shareBtn" class="zbtn">å…±æœ‰</button>
    </div>
  </div>

  <!-- ã‚ºãƒ¼ãƒ  -->
  <div id="zoom">
    <button class="zbtn" data-z="1">1Ã—</button>
    <button class="zbtn" data-z="2">2Ã—</button>
    <button class="zbtn" data-z="4">4Ã—</button>
  </div>

  <!-- ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ -->
  <div id="controls">
    <button id="shutter"></button>
  </div>

</div>

<script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const zoom = document.getElementById('zoom');
const controls = document.getElementById('controls');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const backBtn = document.getElementById('backBtn');
const shareBtn = document.getElementById('shareBtn');
const reloadBtn = document.getElementById('reloadBtn');
const landBtn = document.getElementById('landBtn');
const portBtn = document.getElementById('portBtn');

let track, imageCapture;
let orientation = 'landscape'; // ä¿å­˜ç”¨æ§‹å›³

// æ§‹å›³åˆ‡æ›¿
landBtn.onclick = ()=> orientation='landscape';
portBtn.onclick = ()=> orientation='portrait';

// ã‚«ãƒ¡ãƒ©èµ·å‹•
(async()=>{
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:'environment',width:{ideal:4032},height:{ideal:3024}}
  });
  video.srcObject = stream;
  track = stream.getVideoTracks()[0];
  if('ImageCapture' in window) imageCapture = new ImageCapture(track);
})();

// Canvasã§ä¿å­˜ç”¨ç”»åƒç”Ÿæˆ
async function createOutputBlob(){
  let blob;
  if(imageCapture?.takePhoto){
    blob = await imageCapture.takePhoto();
  }else{
    const c=document.createElement('canvas');
    c.width=video.videoWidth;c.height=video.videoHeight;
    c.getContext('2d').drawImage(video,0,0);
    blob = await new Promise(r=>c.toBlob(r,'image/jpeg',0.95));
  }

  const img = new Image();
  img.src = URL.createObjectURL(blob);
  await img.decode();

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  if(orientation==='portrait'){
    const w = img.height*3/4;
    const x = (img.width-w)/2;
    canvas.width = img.height;
    canvas.height = w;
    ctx.translate(canvas.width/2,canvas.height/2);
    ctx.rotate(-Math.PI/2);
    ctx.drawImage(img,x,0,w,img.height,-canvas.height/2,-canvas.width/2,canvas.height,canvas.width);
  }else{
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);
  }

  return new Promise(r=>canvas.toBlob(r,'image/jpeg',0.95));
}

// æ’®å½±
shutter.onclick = async ()=>{
  const outBlob = await createOutputBlob();
  previewImg.src = URL.createObjectURL(outBlob);

  preview.style.display='block';
  controls.style.display='none';
  zoom.style.display='none';
};

// æˆ»ã‚‹
backBtn.onclick=()=>{
  preview.style.display='none';
  controls.style.display='flex';
  zoom.style.display='flex';
  URL.revokeObjectURL(previewImg.src);
};

// å…±æœ‰
shareBtn.onclick=async()=>{
  const blob = await fetch(previewImg.src).then(r=>r.blob());
  const file = new File([blob],'photo.jpg',{type:'image/jpeg'});
  await navigator.share({files:[file]});
};

// å†èµ·å‹•
reloadBtn.onclick=()=>location.reload();
</script>
</body>
</html>
