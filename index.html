<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>iPad Camera</title>

<style>
html,body{
  margin:0;height:100%;background:#000;overflow:hidden;
}
#wrap{
  position:relative;width:100%;height:100%;
  display:flex;justify-content:center;align-items:center;
  flex-direction:column;
}

/* ===== æ’®å½±ãƒ“ãƒ¥ãƒ¼ ===== */
#cameraArea{
  position:relative;
  width:90%;
  aspect-ratio:3/4; /* ç¸¦4:æ¨ª3 */
}
video{
  width:100%;height:100%;
  object-fit:contain;
}

/* ã‚¬ã‚¤ãƒ‰æ  */
#guide{
  position:absolute;inset:0;
  border:2px dashed rgba(255,255,255,.6);
  display:none;
  pointer-events:none;
}

/* ===== UI ===== */
#shutter{
  width:78px;height:78px;
  border-radius:50%;
  background:#fff;border:none;
  margin-top:16px;
}
#zoom{
  position:absolute;right:16px;bottom:140px;
  display:flex;flex-direction:column;gap:10px;
}
.zbtn{
  background:rgba(0,0,0,.6);
  color:#fff;border:1px solid #fff;
  border-radius:999px;
  padding:8px 12px;
}

/* å†èµ·å‹• */
#reload{
  position:absolute;top:16px;right:16px;
}

/* ===== ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ===== */
#preview{
  display:none;
  flex-direction:column;
  align-items:center;
  width:100%;
}
#preview img{
  width:80%;
  max-height:65%;
  object-fit:contain;
}
#shareBtn{
  margin-top:20px;
  width:80%;
  padding:16px;
  font-size:18px;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
#loading{
  display:none;
  position:absolute;inset:0;
  background:#000;
  color:#fff;
  font-size:18px;
  justify-content:center;
  align-items:center;
}
</style>
</head>

<body>
<div id="wrap">

  <div id="cameraArea">
    <video id="video" autoplay playsinline></video>
    <div id="guide"></div>
  </div>

  <button id="shutter"></button>

  <div id="zoom">
    <button class="zbtn" data-z="1">1Ã—</button>
    <button class="zbtn" data-z="2">2Ã—</button>
    <button class="zbtn" data-z="4">4Ã—</button>
    <button class="zbtn" data-z="8">8Ã—</button>
    <button class="zbtn" id="guideBtn">ğŸ“</button>
  </div>

  <button id="reload" class="zbtn">ğŸ”„</button>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div id="preview">
    <img id="previewImg">
    <button id="shareBtn" class="zbtn">ğŸ“¤ å…±æœ‰</button>
  </div>

  <div id="loading">å†èµ·å‹•ä¸­â€¦</div>
</div>

<script>
const video = document.getElementById('video');
const shutter = document.getElementById('shutter');
const zoomBtns = document.querySelectorAll('[data-z]');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const shareBtn = document.getElementById('shareBtn');
const reloadBtn = document.getElementById('reload');
const guide = document.getElementById('guide');
const guideBtn = document.getElementById('guideBtn');
const loading = document.getElementById('loading');

let stream, track, imageCapture;

// èµ·å‹•
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{
      facingMode:'environment',
      width:{ideal:4000},
      height:{ideal:3000}
    }
  });
  video.srcObject = stream;
  track = stream.getVideoTracks()[0];
  if('ImageCapture' in window){
    imageCapture = new ImageCapture(track);
  }
}
startCamera();

// æ’®å½±
shutter.onclick = async ()=>{
  let blob;
  if(imageCapture?.takePhoto){
    blob = await imageCapture.takePhoto();
  }else{
    const c = document.createElement('canvas');
    c.width = video.videoWidth;
    c.height = video.videoHeight;
    c.getContext('2d').drawImage(video,0,0);
    blob = await new Promise(r=>c.toBlob(r,'image/jpeg',0.95));
  }

  previewImg.src = URL.createObjectURL(blob);
  preview.style.display = 'flex';
  document.getElementById('cameraArea').style.display = 'none';
  shutter.style.display = 'none';
  document.getElementById('zoom').style.display = 'none';
};

// å…±æœ‰
shareBtn.onclick = async ()=>{
  const res = await fetch(previewImg.src);
  const blob = await res.blob();
  const file = new File([blob],'photo.jpg',{type:'image/jpeg'});
  await navigator.share({files:[file]});
};

// ã‚ºãƒ¼ãƒ ä¿®æ­£
zoomBtns.forEach(b=>{
  b.onclick = async ()=>{
    const z = Number(b.dataset.z);
    if(track?.getCapabilities){
      const caps = track.getCapabilities();
      if(caps.zoom){
        await track.applyConstraints({advanced:[{zoom:Math.min(z,caps.zoom.max)}]});
        return;
      }
    }
    video.style.transform = `scale(${z})`;
  };
});

// ã‚¬ã‚¤ãƒ‰
guideBtn.onclick = ()=>{
  guide.style.display = guide.style.display==='none'?'block':'none';
};

// å†èµ·å‹•
reloadBtn.onclick = ()=>{
  loading.style.display='flex';
  setTimeout(()=>location.reload(),800);
};
</script>
</body>
</html>
